<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Heat Risk Monitor</title>
  <style>
    body { font-family: system-ui, Arial, sans-serif; background:#f7f7f7; padding: 32px; }
    .card { background:#fff; max-width: 560px; margin:auto; padding:20px; border-radius:14px; box-shadow:0 4px 12px rgba(0,0,0,.08); }
    .title { font-size:22px; text-align:center; margin-bottom:8px; }

    .badge { font-size:26px; text-align:center; margin:6px 0 12px; padding:6px 10px; border-radius:10px; display:block; }
    .badge.normal  { background:#e8f7ee; color:#0a6b38; }   /* ✅ Normal */
    .badge.watch   { background:#fff6e6; color:#8a5a00; }   /* 👀 Watch */
    .badge.warning { background:#fdecea; color:#8a1c1c; }   /* ⚠️ Warning */
    .badge.high    { background:#ffe5e9; color:#a30b2a; }   /* 🚨 High Risk */
    .badge.stand   { background:#eef2ff; color:#23336e; }   /* 🧍 Standing */
    .badge.notworn { background:#f0f0f0; color:#666; }      /* 👟 Not Worn */
    .badge.nosense { background:#eee;    color:#444; }      /* ❌ Not Sensing */

    .sub { color:#666; text-align:center; margin-bottom:18px; min-height:20px; }
    .grid { display:grid; grid-template-columns: repeat(3, 1fr); gap:12px; }
    .tile { padding:12px; border:1px solid #eee; border-radius:12px; background:#fff; }
    .label { font-size:12px; color:#666; text-transform:uppercase; letter-spacing:.04em; }
    .value { font-size:22px; margin-top:6px; }
    .meta { color:#666; text-align:center; margin-top:14px; }
  </style>
</head>
<body>
  <div class="card">
    <div class="title">👣 Gait Status Monitor</div>
    <div id="status" class="badge nosense">❌ Not Sensing</div>
    <div id="reasons" class="sub"></div>

    <div class="grid">
      <div class="tile"><div class="label">Cadence (spm)</div><div class="value" id="cad">–</div></div>
      <div class="tile"><div class="label">Step CV</div><div class="value" id="stepcv">–</div></div>
      <div class="tile"><div class="label">Stance CV</div><div class="value" id="stancecv">–</div></div>
    </div>

    <div id="meta" class="meta"></div>
  </div>

  <script>
    const el = id => document.getElementById(id);
    const niceReason = r => ({
      "cadence_low":"Cadence low",
      "cadence_high":"Cadence high",
      "cadence_watch":"Cadence drifting",
      "cadence_warn":"Cadence out of range",
      "stepcv_watch":"Stride timing inconsistent",
      "stepcv_warn":"Stride timing unstable",
      "stancecv_watch":"Stance variability high",
      "stancecv_warn":"Stance variability very high",
      "sway_watch":"Sway elevated",
      "sway_warn":"Sway high",
      "critical_posture":"Collapse posture",
      "gait_abnormal":"Gait abnormal",
      "gait_drifting":"Gait drifting",
      "no_foot":"Not worn",
      "standing":"Standing"
    }[r] || r);

    const fmt = (v, d=3) => (Number.isFinite(v) ? v.toFixed(d) : "–");
    const ago = ts => !ts ? "never" : `${Math.max(0, Math.floor((Date.now()-ts)/1000))}s ago`;

    function statusClass(s){
      if (!s) return "nosense";
      if (s.includes("High Risk")) return "high";
      if (s.includes("Warning"))   return "warning";
      if (s.includes("Watch"))     return "watch";
      if (s.includes("Standing"))  return "stand";
      if (s.includes("Not Worn"))  return "notworn";
      if (s.includes("Not Sensing")) return "nosense";
      return "normal";
    }

    async function tick(){
      try{
        const r = await fetch("/status");
        const d = await r.json();

        const cls = statusClass(String(d.status));
        const badge = el("status");
        badge.className = `badge ${cls}`;
        badge.textContent = `${d.status} — ${d.recruit || "-"} — ${d.worn ? "👞 Worn" : "👟 Not Worn"}`;

        const reasons = (d.reasons || []).slice(0,2).map(niceReason).join("; ");
        el("reasons").textContent = reasons;

        el("cad").textContent     = fmt(d.cadence, 1);
        el("stepcv").textContent  = fmt(d.step_cv, 3);
        el("stancecv").textContent= fmt(d.stance_cv, 3);

        el("meta").textContent = `Mode: ${d.mode || "—"} • Updated: ${ago(d.updated_at)}`;
      } catch (e){
        const badge = el("status");
        badge.className = "badge nosense";
        badge.textContent = "❌ Not Sensing";
        el("reasons").textContent = "";
        el("cad").textContent = el("stepcv").textContent = el("stancecv").textContent = "–";
        el("meta").textContent = "Disconnected";
      }
    }

    tick();
    setInterval(tick, 2000);
  </script>
</body>
</html>
